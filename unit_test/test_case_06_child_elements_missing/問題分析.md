# 子要素欠落問題の分析

## 問題の概要

検証結果ファイル（`02_H13null[2490]1347_R06null[2490]1000_R070401_2_validation_v2.md`）で確認された問題：
- ファイル2に欠落している値: 43件
- ファイル2に追加されている値: 55件
- 順序または内容の差異: 43件

## 原因分析

### 1. ArithFormula要素の欠落

**入力XML:**
```xml
<Sentence Num="41">（式）　<ArithFormula>Ｌｗ＝（Ｚ・Ａｉ・Ｃ<Sub>０</Sub>・Σｗｉ）／（０．０１９６・Ａｆｉ）</ArithFormula></Sentence>
```

**現在の処理:**
- `convert_sentence_to_list`関数は`sentence_elem.text`のみを処理
- `text = "（式）　"`のみが処理され、`ArithFormula`要素が無視される
- 分割後、Column 2が空になる

**期待される動作:**
- `ArithFormula`要素をColumn 2に配置する必要がある

### 2. Sup/Sub要素の欠落

**入力XML:**
```xml
<Sentence Num="43">Ｌｗ　単位面積あたりの必要壁量（単位　１ｍ<Sup>２</Sup>につきｃｍ）</Sentence>
```

**現在の処理:**
- テキストのみが分割され、`<Sup>２</Sup>`の部分が失われる
- 出力: `単位面積あたりの必要壁量（単位　１ｍ`（途中で切れる）

**期待される動作:**
- `Sup`要素を含めて正しく分割する必要がある

### 3. 全角スペースの削除

**入力XML:**
```xml
<Sentence Num="46">Ｃ<Sub>０</Sub>　０．２（特定行政庁が令第８８条第２項の規定によって指定した区域内における場合においては、０．３）</Sentence>
```

**現在の処理:**
- 全角スペースで分割されるが、`<Sub>０</Sub>`の後に全角スペースがないと判断される
- 出力: `Ｃ００．２...`（全角スペースが削除される）

**期待される動作:**
- 子要素を含めてテキストを取得し、全角スペースで正しく分割する必要がある

## 根本原因

`xml_converter.py`の`convert_sentence_to_list`関数（8-53行目）では：

```python
def convert_sentence_to_list(sentence_elem):
    """Sentence要素をList要素に変換する"""
    text = sentence_elem.text or ""  # ← ここでテキストのみを取得
    
    # 冒頭10文字以内に空白があるかチェック
    first_10_chars = text[:10]
    space_match = re.search(r'\s', first_10_chars)
    
    if space_match:
        # テキストのみを分割
        prefix = text[:space_pos]
        suffix = text[space_pos + 1:]
        
        # Column 1とColumn 2を作成
        sentence1.text = prefix
        sentence2.text = suffix
        
        # Ruby要素がある場合は適切な位置に配置
        for child in sentence_elem:
            if child.tag == 'Ruby':  # ← Ruby要素のみ処理
                sentence2.append(child)
```

**問題点:**
1. `sentence_elem.text`のみを処理し、子要素のテキストを無視している
2. `Ruby`要素のみを処理し、`ArithFormula`、`Sub`、`Sup`などの要素を処理していない
3. 子要素を含めたテキスト全体を考慮していない

## 修正が必要な箇所

1. **子要素を含めたテキスト取得**
   - `sentence_elem.text`だけでなく、子要素のテキストも含めて処理する必要がある
   - または、子要素を適切に処理する必要がある

2. **分割時の子要素の処理**
   - 分割点が子要素の前後にある場合、子要素を適切なColumnに配置する必要がある
   - `ArithFormula`、`Sub`、`Sup`などの要素も処理する必要がある

3. **全角スペースの検出**
   - 子要素を含めたテキスト全体から全角スペースを検出する必要がある

## テストケースでの検証

`test_case_06_child_elements_missing`テストケースで以下の問題を検証：

1. ✅ `ArithFormula`要素の欠落が確認された
2. ✅ `Sup`要素の欠落が確認された
3. ✅ 全角スペースの削除が確認された

このテストケースは、修正後の動作確認にも使用できます。
